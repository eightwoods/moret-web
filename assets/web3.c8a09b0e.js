import{t as D,g as b,e as B,m as L,a as R}from"./main.f8e95f81.js";var Z=20,Q=1,j=1e6,U=1e6,tt=-7,et=21,ot=!1,I="[big.js] ",A=I+"Invalid ",y=A+"decimal places",rt=A+"rounding mode",H=I+"Division by zero",w={},W=void 0,nt=/^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i;function J(){function t(e){var o=this;if(!(o instanceof t))return e===W?J():new t(e);if(e instanceof t)o.s=e.s,o.e=e.e,o.c=e.c.slice();else{if(typeof e!="string"){if(t.strict===!0&&typeof e!="bigint")throw TypeError(A+"value");e=e===0&&1/e<0?"-0":String(e)}it(o,e)}o.constructor=t}return t.prototype=w,t.DP=Z,t.RM=Q,t.NE=tt,t.PE=et,t.strict=ot,t.roundDown=0,t.roundHalfUp=1,t.roundHalfEven=2,t.roundUp=3,t}function it(t,e){var o,r,n;if(!nt.test(e))throw Error(A+"number");for(t.s=e.charAt(0)=="-"?(e=e.slice(1),-1):1,(o=e.indexOf("."))>-1&&(e=e.replace(".","")),(r=e.search(/e/i))>0?(o<0&&(o=r),o+=+e.slice(r+1),e=e.substring(0,r)):o<0&&(o=e.length),n=e.length,r=0;r<n&&e.charAt(r)=="0";)++r;if(r==n)t.c=[t.e=0];else{for(;n>0&&e.charAt(--n)=="0";);for(t.e=o-r-1,t.c=[],o=0;r<=n;)t.c[o++]=+e.charAt(r++)}return t}function k(t,e,o,r){var n=t.c;if(o===W&&(o=t.constructor.RM),o!==0&&o!==1&&o!==2&&o!==3)throw Error(rt);if(e<1)r=o===3&&(r||!!n[0])||e===0&&(o===1&&n[0]>=5||o===2&&(n[0]>5||n[0]===5&&(r||n[1]!==W))),n.length=1,r?(t.e=t.e-e+1,n[0]=1):n[0]=t.e=0;else if(e<n.length){if(r=o===1&&n[e]>=5||o===2&&(n[e]>5||n[e]===5&&(r||n[e+1]!==W||n[e-1]&1))||o===3&&(r||!!n[0]),n.length=e--,r)for(;++n[e]>9;)n[e]=0,e--||(++t.e,n.unshift(1));for(e=n.length;!n[--e];)n.pop()}return t}function S(t,e,o){var r=t.e,n=t.c.join(""),i=n.length;if(e)n=n.charAt(0)+(i>1?"."+n.slice(1):"")+(r<0?"e":"e+")+r;else if(r<0){for(;++r;)n="0"+n;n="0."+n}else if(r>0)if(++r>i)for(r-=i;r--;)n+="0";else r<i&&(n=n.slice(0,r)+"."+n.slice(r));else i>1&&(n=n.charAt(0)+"."+n.slice(1));return t.s<0&&o?"-"+n:n}w.abs=function(){var t=new this.constructor(this);return t.s=1,t};w.cmp=function(t){var e,o=this,r=o.c,n=(t=new o.constructor(t)).c,i=o.s,c=t.s,s=o.e,u=t.e;if(!r[0]||!n[0])return r[0]?i:n[0]?-c:0;if(i!=c)return i;if(e=i<0,s!=u)return s>u^e?1:-1;for(c=(s=r.length)<(u=n.length)?s:u,i=-1;++i<c;)if(r[i]!=n[i])return r[i]>n[i]^e?1:-1;return s==u?0:s>u^e?1:-1};w.div=function(t){var e=this,o=e.constructor,r=e.c,n=(t=new o(t)).c,i=e.s==t.s?1:-1,c=o.DP;if(c!==~~c||c<0||c>j)throw Error(y);if(!n[0])throw Error(H);if(!r[0])return t.s=i,t.c=[t.e=0],t;var s,u,a,h,f,p=n.slice(),E=s=n.length,T=r.length,g=r.slice(0,s),m=g.length,v=t,d=v.c=[],C=0,x=c+(v.e=e.e-t.e)+1;for(v.s=i,i=x<0?0:x,p.unshift(0);m++<s;)g.push(0);do{for(a=0;a<10;a++){if(s!=(m=g.length))h=s>m?1:-1;else for(f=-1,h=0;++f<s;)if(n[f]!=g[f]){h=n[f]>g[f]?1:-1;break}if(h<0){for(u=m==s?n:p;m;){if(g[--m]<u[m]){for(f=m;f&&!g[--f];)g[f]=9;--g[f],g[m]+=10}g[m]-=u[m]}for(;!g[0];)g.shift()}else break}d[C++]=h?a:++a,g[0]&&h?g[m]=r[E]||0:g=[r[E]]}while((E++<T||g[0]!==W)&&i--);return!d[0]&&C!=1&&(d.shift(),v.e--,x--),C>x&&k(v,x,o.RM,g[0]!==W),v};w.eq=function(t){return this.cmp(t)===0};w.gt=function(t){return this.cmp(t)>0};w.gte=function(t){return this.cmp(t)>-1};w.lt=function(t){return this.cmp(t)<0};w.lte=function(t){return this.cmp(t)<1};w.minus=w.sub=function(t){var e,o,r,n,i=this,c=i.constructor,s=i.s,u=(t=new c(t)).s;if(s!=u)return t.s=-u,i.plus(t);var a=i.c.slice(),h=i.e,f=t.c,p=t.e;if(!a[0]||!f[0])return f[0]?t.s=-u:a[0]?t=new c(i):t.s=1,t;if(s=h-p){for((n=s<0)?(s=-s,r=a):(p=h,r=f),r.reverse(),u=s;u--;)r.push(0);r.reverse()}else for(o=((n=a.length<f.length)?a:f).length,s=u=0;u<o;u++)if(a[u]!=f[u]){n=a[u]<f[u];break}if(n&&(r=a,a=f,f=r,t.s=-t.s),(u=(o=f.length)-(e=a.length))>0)for(;u--;)a[e++]=0;for(u=e;o>s;){if(a[--o]<f[o]){for(e=o;e&&!a[--e];)a[e]=9;--a[e],a[o]+=10}a[o]-=f[o]}for(;a[--u]===0;)a.pop();for(;a[0]===0;)a.shift(),--p;return a[0]||(t.s=1,a=[p=0]),t.c=a,t.e=p,t};w.mod=function(t){var e,o=this,r=o.constructor,n=o.s,i=(t=new r(t)).s;if(!t.c[0])throw Error(H);return o.s=t.s=1,e=t.cmp(o)==1,o.s=n,t.s=i,e?new r(o):(n=r.DP,i=r.RM,r.DP=r.RM=0,o=o.div(t),r.DP=n,r.RM=i,this.minus(o.times(t)))};w.neg=function(){var t=new this.constructor(this);return t.s=-t.s,t};w.plus=w.add=function(t){var e,o,r,n=this,i=n.constructor;if(t=new i(t),n.s!=t.s)return t.s=-t.s,n.minus(t);var c=n.e,s=n.c,u=t.e,a=t.c;if(!s[0]||!a[0])return a[0]||(s[0]?t=new i(n):t.s=n.s),t;if(s=s.slice(),e=c-u){for(e>0?(u=c,r=a):(e=-e,r=s),r.reverse();e--;)r.push(0);r.reverse()}for(s.length-a.length<0&&(r=a,a=s,s=r),e=a.length,o=0;e;s[e]%=10)o=(s[--e]=s[e]+a[e]+o)/10|0;for(o&&(s.unshift(o),++u),e=s.length;s[--e]===0;)s.pop();return t.c=s,t.e=u,t};w.pow=function(t){var e=this,o=new e.constructor("1"),r=o,n=t<0;if(t!==~~t||t<-U||t>U)throw Error(A+"exponent");for(n&&(t=-t);t&1&&(r=r.times(e)),t>>=1,!!t;)e=e.times(e);return n?o.div(r):r};w.prec=function(t,e){if(t!==~~t||t<1||t>j)throw Error(A+"precision");return k(new this.constructor(this),t,e)};w.round=function(t,e){if(t===W)t=0;else if(t!==~~t||t<-j||t>j)throw Error(y);return k(new this.constructor(this),t+this.e+1,e)};w.sqrt=function(){var t,e,o,r=this,n=r.constructor,i=r.s,c=r.e,s=new n("0.5");if(!r.c[0])return new n(r);if(i<0)throw Error(I+"No square root");i=Math.sqrt(r+""),i===0||i===1/0?(e=r.c.join(""),e.length+c&1||(e+="0"),i=Math.sqrt(e),c=((c+1)/2|0)-(c<0||c&1),t=new n((i==1/0?"5e":(i=i.toExponential()).slice(0,i.indexOf("e")+1))+c)):t=new n(i+""),c=t.e+(n.DP+=4);do o=t,t=s.times(o.plus(r.div(o)));while(o.c.slice(0,c).join("")!==t.c.slice(0,c).join(""));return k(t,(n.DP-=4)+t.e+1,n.RM)};w.times=w.mul=function(t){var e,o=this,r=o.constructor,n=o.c,i=(t=new r(t)).c,c=n.length,s=i.length,u=o.e,a=t.e;if(t.s=o.s==t.s?1:-1,!n[0]||!i[0])return t.c=[t.e=0],t;for(t.e=u+a,c<s&&(e=n,n=i,i=e,a=c,c=s,s=a),e=new Array(a=c+s);a--;)e[a]=0;for(u=s;u--;){for(s=0,a=c+u;a>u;)s=e[a]+i[u]*n[a-u-1]+s,e[a--]=s%10,s=s/10|0;e[a]=s}for(s?++t.e:e.shift(),u=e.length;!e[--u];)e.pop();return t.c=e,t};w.toExponential=function(t,e){var o=this,r=o.c[0];if(t!==W){if(t!==~~t||t<0||t>j)throw Error(y);for(o=k(new o.constructor(o),++t,e);o.c.length<t;)o.c.push(0)}return S(o,!0,!!r)};w.toFixed=function(t,e){var o=this,r=o.c[0];if(t!==W){if(t!==~~t||t<0||t>j)throw Error(y);for(o=k(new o.constructor(o),t+o.e+1,e),t=t+o.e+1;o.c.length<t;)o.c.push(0)}return S(o,!1,!!r)};w[Symbol.for("nodejs.util.inspect.custom")]=w.toJSON=w.toString=function(){var t=this,e=t.constructor;return S(t,t.e<=e.NE||t.e>=e.PE,!!t.c[0])};w.toNumber=function(){var t=Number(S(this,!0,!0));if(this.constructor.strict===!0&&!this.eq(t.toString()))throw Error(I+"Imprecise conversion");return t};w.toPrecision=function(t,e){var o=this,r=o.constructor,n=o.c[0];if(t!==W){if(t!==~~t||t<1||t>j)throw Error(A+"precision");for(o=k(new r(o),t,e);o.c.length<t;)o.c.push(0)}return S(o,t<=o.e||o.e<=r.NE||o.e>=r.PE,!!n)};w.valueOf=function(){var t=this,e=t.constructor;if(e.strict===!0)throw Error(I+"valueOf disallowed");return S(t,t.e<=e.NE||t.e>=e.PE,!0)};var st=J(),P=st;function V(t){var e=0;if(t>=8)e=1;else if(t<=-8)e=0;else{for(var o=0;o<100;o++)e+=Math.pow(t,2*o+1)/at(2*o+1);e*=Math.pow(Math.E,-.5*Math.pow(t,2)),e/=Math.sqrt(2*Math.PI),e+=.5}return e}function at(t){for(var e=1,o=t;o>1;o-=2)e*=o;return e}function ct(t,e,o,r,n,i){var c=null,s=(n*o+Math.pow(r,2)*o/2-Math.log(e/t))/(r*Math.sqrt(o));return i==="call"?c=t*V(s)-e*Math.pow(Math.E,-1*n*o)*V(s-r*Math.sqrt(o)):c=e*Math.pow(Math.E,-1*n*o)*V(r*Math.sqrt(o)-s)-t*V(-s),c}function lt(t,e,o,r,n){var i=(n*o+Math.pow(r,2)*o/2-Math.log(e/t))/(r*Math.sqrt(o));return i}var ut={blackScholes:ct,stdNormCDF:V,getW:lt},q=ut;function G(t){return Math.pow(Math.E,-1*Math.pow(t,2)/2)/Math.sqrt(2*Math.PI)}function ft(t,e,o,r,n,i){return i==="call"?X(t,e,o,r,n):ht(t,e,o,r,n)}function X(t,e,o,r,n){var i=q.getW(t,e,o,r,n),c=null;return isFinite(i)?c=q.stdNormCDF(i):c=t>e?1:0,c}function ht(t,e,o,r,n){var i=X(t,e,o,r,n)-1;return i==-1&&e==t?0:i}function gt(t,e,o,r,n,i,c){return c=c||100,i==="call"?wt(t,e,o,r,n)/c:mt(t,e,o,r,n)/c}function wt(t,e,o,r,n){var i=q.getW(t,e,o,r,n);return isNaN(i)?0:e*o*Math.pow(Math.E,-1*n*o)*q.stdNormCDF(i-r*Math.sqrt(o))}function mt(t,e,o,r,n){var i=q.getW(t,e,o,r,n);return isNaN(i)?0:-1*e*o*Math.pow(Math.E,-1*n*o)*q.stdNormCDF(r*Math.sqrt(o)-i)}function pt(t,e,o,r,n){var i=q.getW(t,e,o,r,n);return isFinite(i)?t*Math.sqrt(o)*G(i)/100:0}function dt(t,e,o,r,n,i,c){return c=c||365,i==="call"?vt(t,e,o,r,n)/c:Mt(t,e,o,r,n)/c}function vt(t,e,o,r,n){var i=q.getW(t,e,o,r,n);return isFinite(i)?-1*r*t*G(i)/(2*Math.sqrt(o))-e*n*Math.pow(Math.E,-1*n*o)*q.stdNormCDF(i-r*Math.sqrt(o)):0}function Mt(t,e,o,r,n){var i=q.getW(t,e,o,r,n);return isFinite(i)?-1*r*t*G(i)/(2*Math.sqrt(o))+e*n*Math.pow(Math.E,-1*n*o)*q.stdNormCDF(r*Math.sqrt(o)-i):0}function bt(t,e,o,r,n){var i=q.getW(t,e,o,r,n);return isFinite(i)?G(i)/(t*r*Math.sqrt(o)):0}var $={getDelta:ft,getVega:pt,getGamma:bt,getTheta:dt,getRho:gt};const l=new Web3(window.ethereum),N=async(t,e,o)=>{const n=await(await fetch(e)).json();return new t.eth.Contract(n.abi,o)},O=async(t=null)=>{const e=t||D(),r=await(await N(l,b("Moret.json"),R)).methods.getVolatilityChain(String(e)).call();return await N(l,b("VolatilityChain.json"),r)},Ct=async(t=null)=>{const e=t||D(),r=await(await O(e)).methods.queryPrice().call();return`$${P(l.utils.fromWei(r)).round(2).toNumber()}`},Pt=async(t=null,e)=>{const o=t||D(),n=await(await O(o)).methods.queryPrice().call(),i=P(l.utils.fromWei(n)).toNumber(),c=[.6,.7,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.3,1.4],s=50,u=[];for(let a of c){let h=P(i).times(a).div(s).round().times(s).toNumber(),f=await Nt(o,h,e);u.push(`${h} | ${f}`)}return u},Nt=async(t=null,e,o)=>{const r=t||D(),i=await(await O(r)).methods.queryPrice().call(),c=P(l.utils.fromWei(i)).toNumber(),s=P(e).div(c).times(100).round().toNumber();return s===100?"ATM":s>100?`${(s-100).toString()}${o?"% OTM":"% ITM"}`:`${(100-s).toString()}${o?"% ITM":"% OTM"}`},qt=async(t=null)=>{const e=t||D(),o=await O(e),r=[1,7,30];let n=[];for(let i of r){const c=P(i).times(86400).round().toNumber(),s=P(i).div(365),u=await o.methods.queryVol(c).call(),a=`${P(l.utils.fromWei(u)).div(s.sqrt()).toNumber().toLocaleString(void 0,{style:"percent",minimumFractionDigits:0})} RV`,h=P(i).eq(1)?"":"s";n.push(`${i} Day${h} | ${a}`)}return n},Et=async(t=null,e)=>{const o=t||D(),r=await N(l,b("Moret.json"),R),n=P(e).times(86400).round().toNumber();try{const i=await r.methods.getVolatilityToken(o,n).call();return await(await N(l,b("VolatilityToken.json"),i)).methods.symbol().call()}catch{return""}},K=async(t=null,e=null,o,r,n,i,c,s)=>{try{const g=t||D(),m=await N(l,b("Exchange.json"),B),v=Math.floor(s*86400),d=await Y(g);var u=0 .toString(16),a,h,f=0,p=0;for(let C=0;C<d.length;C++){const x=d[C],F=await m.methods.queryOption(x,v,l.utils.toWei(i.toString(),"ether"),l.utils.toWei(c.toString(),"ether"),r?0:1,o?0:1,!1).call(),M=parseFloat(l.utils.fromWei(l.utils.toBN(F[0])));(parseInt(u,16)==0||o&&M<a||!o&&M>a)&&(a=M,h=parseFloat(l.utils.fromWei(l.utils.toBN(F[1]))),p=parseFloat(l.utils.fromWei(l.utils.toBN(F[2]))),f=parseFloat(l.utils.fromWei(l.utils.toBN(F[3]))),u=x)}if(f==0||p==0)throw"There is no available liquidity pool.";var E="USDC",T="USDC";return n==0||(n==1?(a=a/p,h=h/p,E=T=e):n==2&&(a=a/f,E=await Et(g,s))),e?{volatility:f.toLocaleString(void 0,{style:"percent",minimumFractionDigits:0}),premium:`${P(a).round(5)}${E}`,collateral:`${P(h).round(2)}${T}`}:{volatility:f,premium:a,collateral:h,pool:u}}catch(g){return g.message}},Y=async(t=null)=>{const e=t||D(),r=await(await N(l,b("Moret.json"),R)).methods.broker().call();return await(await N(l,b("MoretBroker.json"),r)).methods.getAllPools(e).call()},Dt=async(t=null)=>{const e=t||D(),r=await(await N(l,b("Exchange.json"),B)).methods.vault().call(),n=await N(l,b("OptionVault.json"),r),i=await Y(e);var c=0,s=0;for(let a=0;a<i.length;a++){const h=i[a],f=await n.methods.calcCapital(h,!1,!1).call(),p=await n.methods.calcCapital(h,!0,!1).call();c=c+parseFloat(l.utils.fromWei(f)),s=s+parseFloat(l.utils.fromWei(p))}const u=Math.max(0,1-s/c);return{gross:`$${c/1e3}K`,perc:u.toLocaleString(void 0,{style:"percent",minimumFractionDigits:0})}},xt=async(t=null,e,o,r,n,i,c)=>{const s=t||D(),u=await N(l,b("Moret.json"),R),a=await K(s,null,e,o,r,n,i,c);console.log(a);const h=await u.methods.funding().call(),f=Math.floor(c*86400);var p=r==0?h:s;if(r==2)try{p=await u.methods.getVolatilityToken(s,f).call()}catch{console.log(`no vol token exists for ${c.toString()}`)}const E=await N(l,b("ERC20.json"),p),T=await N(l,b("ERC20.json"),r==1?s:h);var g=await ethereum.request({method:"eth_requestAccounts"}),m=l.utils.toChecksumAddress(g[0]);try{await z(E,m,B,a.premium),await z(T,m,B,a.collateral)}catch(v){return console.warn(v),"failure"}},z=async(t,e,o,r)=>{var n=await t.methods.allowance(e,o).call();const i=await t.methods.decimals().call();if(l.utils.toBN(l.utils.toWei(r.toString())).mul(l.utils.toBN(10).pow(l.utils.toBN(18-Number(i)))).gt(l.utils.toBN(n))){var s=await l.eth.getGasPrice(),u=await t.methods.approve(o,L).estimateGas({from:e,gasPrice:s});u=Number(l.utils.toBN(u).mul(l.utils.toBN(Number(150))).div(l.utils.toBN(Number(100))));var a=await l.eth.getTransactionCount(e);await t.methods.approve(o,L).send({from:e,gas:u,gasPrice:s,nonce:a})}},Ft=async(t=null,e,o,r,n,i,c)=>{const s=t||D(),u=await K(s,null,e,o,r,n,i,c),a=l.utils.toChecksumAddress(u.pool),h=Math.floor(c*86400);var f=await ethereum.request({method:"eth_requestAccounts"}),p=l.utils.toChecksumAddress(f[0]);try{const m=await N(l,b("Exchange.json"),B);var E=await l.eth.getGasPrice(),T=await m.methods.tradeOption(a,h,l.utils.toWei(n.toString()),l.utils.toWei(i.toString()),o?0:1,e?0:1,r).estimateGas({from:p,gasPrice:E});T=Number(l.utils.toBN(T).mul(l.utils.toBN(Number(150))).div(l.utils.toBN(Number(100))));var g=await l.eth.getTransactionCount(p);let v=null;return await m.methods.tradeOption(a,h,l.utils.toWei(n.toString()),l.utils.toWei(i.toString()),o?0:1,e?0:1,r).send({from:p,gas:T,gasPrice:E,nonce:g}).on("transactionHash",d=>{v=`https://polygonscan.com/tx/${d}`}),v}catch(m){console.warn(m)}},Wt=async(t=null,e=9e3,o=null)=>{const r=t||D(),n=await N(l,b("Exchange.json"),B),i=await n.methods.vault().call(),c=await N(l,b("OptionVault.json"),i);var s=await ethereum.request({method:"eth_requestAccounts"}),u=l.utils.toChecksumAddress(s[0]);const a=await O(r),h=await a.methods.queryPrice().call(),f=parseFloat(l.utils.fromWei(h)),p=await l.eth.getBlockNumber(),E=(o||p)-e;let T=null;await n.getPastEvents("NewOption",{filter:{_purchaser:u,_underlying:r},fromBlock:E,toBlock:o||p},async(m,v)=>{T=v});let g=[];for(let m=0;m<T.length;m++){const v=T[m].returnValues._optionId,d=await c.methods.getOption(v).call(),C=parseFloat(l.utils.fromWei(d.strike)),x=parseFloat(l.utils.fromWei(d.amount)),F=Math.floor((d.maturity*1e3-Date.now())/1e3),M=F/(3600*24*365),_=F<=0?0:await a.methods.queryVol(F).call();g.push({Type:d.poType==0?"Call":"Put",BS:d.side==0?"Buy":"Sell",Expiry:new Date(d.maturity*1e3).toLocaleString(),Strike:C.toFixed(0),Amount:x.toFixed(3),Delta:(M<=0?0:$.getDelta(f,C,M,parseFloat(l.utils.fromWei(_))/Math.sqrt(M),0,d.poType==0?"call":"put")*(d.side==0?1:-1)).toFixed(3),Gamma:(M<=0?0:$.getGamma(f,C,M,parseFloat(l.utils.fromWei(_))/Math.sqrt(M),0)*(d.side==0?1:-1)).toFixed(3),Vega:(M<=0?0:$.getVega(f,C,M,parseFloat(l.utils.fromWei(_))/Math.sqrt(M),0)*(d.side==0?1:-1)).toFixed(3),Theta:(M<=0?0:$.getTheta(f,C,M,parseFloat(l.utils.fromWei(_))/Math.sqrt(M),0,d.poType==0?"call":"put")*(d.side==0?1:-1)).toFixed(3)})}return g};export{P as B,Et as a,Pt as b,Nt as c,qt as d,K as e,Dt as f,Ct as g,xt as h,Ft as i,Wt as j,l as w};
