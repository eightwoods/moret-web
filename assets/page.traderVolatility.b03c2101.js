import{d,f as y,s as v,i as h}from"./main.2b926913.js";import{d as x,k as b,f as T,l as g,m as w,j as f}from"./web3.614c2ae5.js";import u from"./component.dropdownSelect.1979fe55.js";import S from"./component.percentageBar.0b052089.js";import q from"./component.tables.e409e8b4.js";import m from"./component.toggleSwitches.d31686b5.js";import C from"./component.tradingviewWidget.80bde1e1.js";var O={globals:{elem:document.querySelector(".trader-volatility"),init:!0,execIntervalId:null},init(){this.optAmount(),this.optExpiry(),this.buttonTrade(),this.transactionsTable();const t={childList:!0,attributes:!0,attributeFilter:["sidenav-activechange","sidenav-refreshprice"]};new MutationObserver(n=>{console.log("sidenav refreshed from Trader Volatility!");for(let i of n)if(i.type==="attributes")switch(i.attributeName){case"sidenav-activechange":C.createGraph(),this.optPrice(),this.liquidityPool();break;case"sidenav-refreshprice":this.optPrice(),document.querySelector(".overlay-popup")&&this.optPrice(!0);break}this.globals.init=!1}).observe(this.globals.elem.querySelector(".sidenav"),t);const o={attributes:!0,attributeFilter:["ts-activechanged","dds-updated"]},e=new MutationObserver(n=>{for(let i of n)if(i.attributeName==="ts-activechanged"||i.attributeName==="dds-updated"){if(i.target.classList.contains("opt-callput")){const l=document.querySelector(".opt-strike");parseInt(l.getAttribute("dds-selected"))===0&&u.valueFromInputField(l,l.querySelector(".ds-value1").textContent),this.optStrike()}this.optPrice()}});e.observe(document.querySelector(".opt-buysell"),o),e.observe(document.querySelector(".opt-expiry"),o);const r=new MutationObserver(n=>{r.disconnect()});r.observe(document.querySelector(".opt-expiry .ds-value1"),{childList:!0})},optAmount(){document.querySelector("input[name='opt-amount']").addEventListener("keydown",a=>{a.keyCode==13&&this.optPrice()},!1)},optExpiry(){u.createListItems(document.querySelector(".opt-expiry"),x())},optPrice(t=!1){new Promise((a,o)=>{setTimeout(()=>{a({amount:this.getAmountValue(),expiry:this.getExpiryValue()})},this.globals.init?2e3:500)}).then(async a=>{const o=await b(null,d(),this.isBuy(),a.amount,a.expiry);t?(document.querySelector(".overlay-popup .to-volatility span").textContent=o.volatility,document.querySelector(".overlay-popup .to-vol-premium span").textContent=o.volpremium):(document.querySelector(".opt-price .info-volatility").textContent=o.volatility,document.querySelector(".opt-price .info-vol-premium").textContent=o.volpremium)}).catch(a=>console.warn(a))},async liquidityPool(){const t=await T();document.querySelector(".liquidity-pool .pb-price-end").textContent=t.gross,document.querySelector(".liquidity-pool .pb-price-from").textContent=t.utilized,document.querySelector(".liquidity-pool .pb-text-value").textContent=t.text,S.progressBar(document.querySelector(".liquidity-pool"),t.perc)},buttonTrade(){document.querySelector(".opt-price .btn").addEventListener("click",async a=>{a.preventDefault();const o=[{name:`${m.getActiveItem(document.querySelector(".opt-buysell"))}:`,span:`volatility token on ${d()} - ${y()}`,class:"to-buy"},{name:"Expiry:",span:"-",class:"to-expiry"},{name:"Dollar Amount:",span:this.getAmountValue(),class:"to-amount"},{name:"Implied Volatility:",span:"-",class:"to-volatility"},{name:"Volatility Token Amount:",span:"-",class:"to-vol-premium"}];v("Trade overview",h(o,"tradeoverview")),u.insertValues(document.querySelector(".opt-expiry"),document.querySelector(".overlay-popup .to-expiry span"),!0),this.optPrice(!0),setTimeout(()=>this.executeTrade(),500)})},executeTrade(){const t=document.createElement("div");t.className="executetrade",document.querySelector(".overlay-popup .op-content").appendChild(t);const a=document.createElement("a");a.setAttribute("href","#"),a.className="btn btn-blue",a.textContent="Execute",t.appendChild(a),a.addEventListener("click",async o=>{o.preventDefault(),a.remove();const e=document.createElement("div");e.className="await-approval",e.textContent="Awaiting for allowance approval";const r=document.createElement("div");r.className="await-approval-timer",r.textContent="00:00",e.appendChild(r),t.appendChild(e);const n=document.createElement("div");n.className="await-trade",n.textContent="Awaiting for transaction";const i=document.createElement("div");i.className="await-trade-timer",i.textContent="00:00",n.appendChild(i),t.appendChild(n),this.executeTradeTimer(r);const l="Warning: Transaction has failed.";await g(null,this.isBuy(),this.getAmountValue(),this.getExpiryValue())==="failure"?this.executeTradeFailure(t,l):(e.classList.add("await-active"),e.textContent="Allowance approved.",r.remove(),this.clearTradeTimer(),setTimeout(async()=>{this.executeTradeTimer(i);const p=await w(null,this.isBuy(),this.getAmountValue(),this.getExpiryValue());if(p==="")this.executeTradeFailure(t,l);else{n.classList.add("await-active"),n.textContent="Transaction mined.",i.remove(),this.clearTradeTimer();const c=document.createElement("div");c.className="approve-trade-link";const s=document.createElement("a");s.setAttribute("href",p),s.setAttribute("target","_blank"),s.className="link-arrow",s.textContent="View on Polygonscan",c.appendChild(s),t.appendChild(c)}},500))},!1)},executeTradeFailure(t,a){const o=document.createElement("div");o.className="await-failure";const e=document.createElement("div");e.className="warning-icon";const r=document.createElement("div");r.className="warning-text",r.textContent=a,o.appendChild(e),o.appendChild(r),t.appendChild(o)},executeTradeTimer(t){const a=e=>e>9?e:`0${e}`;let o=0;this.globals.execIntervalId=setInterval(()=>{o++,o>120?(this.executeTradeFailure(document.querySelector(".overlay-popup .executetrade"),"Warning: Transaction has taking longer than normal to be mined. You can close the window and try to trade again."),this.clearTradeTimer()):t.textContent=`${a(parseInt(o/60))}:${a(o%60)}`},1e3)},clearTradeTimer(){clearInterval(this.globals.execIntervalId),this.globals.execIntervalId=null,console.log("clearTradeTimer()")},transactionsTable(){f(null).then(t=>{const a=document.querySelector(".transactions .comp-dynamic-table"),o=[];t.forEach(e=>{o.push([e.Type,e.BS,e.Expiry,e.Strike,e.Amount,e.Delta,e.Gamma,e.Vega,e.Theta])}),q.setDynamic(a,o)})},isBuy(){return m.getActiveItem(document.querySelector(".opt-buysell")).toLowerCase()==="buy"},getAmountValue(){return document.querySelector("input[name='opt-amount']").value},getExpiryValue(){return document.querySelector(".opt-expiry .ds-value1").textContent.replace("Days","").replace("Day","").trim()}};export{O as default};
