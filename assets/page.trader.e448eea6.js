import{d,f as y,s as v,i as h}from"./main.2b926913.js";import{a as g,b as x,d as b,e as T,f as S,h as f,i as q,j as k}from"./web3.614c2ae5.js";import c from"./component.dropdownSelect.1979fe55.js";import w from"./component.percentageBar.0b052089.js";import C from"./component.tables.e409e8b4.js";import u from"./component.toggleSwitches.d31686b5.js";import A from"./component.tradingviewWidget.80bde1e1.js";var M={globals:{elem:document.querySelector(".trader"),init:!0,execIntervalId:null},init(){this.optAmount(),this.optExpiry(),this.buttonTrade(),this.transactionsTable();const t={childList:!0,attributes:!0,attributeFilter:["sidenav-activechange","sidenav-refreshprice"]};new MutationObserver(i=>{console.log("sidenav refreshed from Trader!");for(let r of i)if(r.type==="attributes")switch(r.attributeName){case"sidenav-activechange":A.createGraph(),this.optTokenName(),document.querySelector(".opt-strike").removeAttribute("dds-selected"),this.optStrike(!0),this.optPrice(),this.liquidityPool(),this.globals.init||this.optToken();break;case"sidenav-refreshprice":this.optPrice(),document.querySelector(".overlay-popup")&&this.optPrice(!0);break}this.globals.init=!1}).observe(this.globals.elem.querySelector(".sidenav"),t);const e={attributes:!0,attributeFilter:["ts-activechanged","dds-updated"]},o=new MutationObserver(i=>{for(let r of i)if(r.attributeName==="ts-activechanged"||r.attributeName==="dds-updated"){if(r.target.classList.contains("opt-callput")){const s=document.querySelector(".opt-strike");parseInt(s.getAttribute("dds-selected"))===0&&c.valueFromInputField(s,s.querySelector(".ds-value1").textContent),this.optStrike()}else r.target.classList.contains("opt-expiry")&&this.optToken();this.optPrice()}});o.observe(document.querySelector(".opt-buysell"),e),o.observe(document.querySelector(".opt-callput"),e),o.observe(document.querySelector(".opt-token"),e),o.observe(document.querySelector(".opt-strike"),e),o.observe(document.querySelector(".opt-expiry"),e);const n=new MutationObserver(i=>{this.optToken(),n.disconnect()});n.observe(document.querySelector(".opt-expiry .ds-value1"),{childList:!0})},optTokenName(){document.querySelector(".opt-token .ts-token-name").textContent=d()},async optToken(){const t=await g(null,this.getExpiryValue());document.querySelector(".opt-token .ts-token").textContent=t},optStrike(t=!1){c.createListItems(document.querySelector(".opt-strike"),x(null,this.isCall()),!1,t)},optAmount(){document.querySelector("input[name='opt-amount']").addEventListener("keydown",a=>{a.keyCode==13&&this.optPrice()},!1)},optExpiry(){c.createListItems(document.querySelector(".opt-expiry"),b())},optPrice(t=!1){new Promise((a,e)=>{setTimeout(()=>{a({strike:this.getStrikeValue(),amount:this.getAmountValue(),expiry:this.getExpiryValue()})},this.globals.init?2e3:500)}).then(async a=>{const e=await T(null,d(),this.isBuy(),this.isCall(),this.getPaymentMethodValue(),a.strike,a.amount,a.expiry);t?(document.querySelector(".overlay-popup .to-volatility span").textContent=e.volatility,document.querySelector(".overlay-popup .to-premium span").textContent=e.premium,document.querySelector(".overlay-popup .to-collateral span").textContent=e.collateral):(document.querySelector(".opt-price .info-volatility").textContent=e.volatility,document.querySelector(".opt-price .info-premium").textContent=e.premium,document.querySelector(".opt-price .info-collateral").textContent=e.collateral)}).catch(a=>console.warn(a))},async liquidityPool(){const t=await S();document.querySelector(".liquidity-pool .pb-price-end").textContent=t.gross,document.querySelector(".liquidity-pool .pb-price-from").textContent=t.utilized,document.querySelector(".liquidity-pool .pb-text-value").textContent=t.text,w.progressBar(document.querySelector(".liquidity-pool"),t.perc)},buttonTrade(){document.querySelector(".opt-price .btn").addEventListener("click",async a=>{a.preventDefault();const e=[{name:`${u.getActiveItem(document.querySelector(".opt-buysell"))}:`,span:`${u.getActiveItem(document.querySelector(".opt-callput")).toLowerCase()} on ${d()} - ${y()}`,class:"to-buy"},{name:"Strike:",span:"-",class:"to-strike"},{name:"Expiry:",span:"-",class:"to-expiry"},{name:"Amount:",span:this.getAmountValue(),class:"to-amount"},{name:"Implied Volatility:",span:"-",class:"to-volatility"},{name:"Premium:",span:"-",class:"to-premium"},{name:"Collateral:",span:"-",class:"to-collateral"}];v("Trade overview",h(e,"tradeoverview")),c.insertValues(document.querySelector(".opt-strike"),document.querySelector(".overlay-popup .to-strike span")),c.insertValues(document.querySelector(".opt-expiry"),document.querySelector(".overlay-popup .to-expiry span"),!0),this.optPrice(!0),setTimeout(()=>this.executeTrade(),500)})},executeTrade(){const t=document.createElement("div");t.className="executetrade",document.querySelector(".overlay-popup .op-content").appendChild(t);const a=document.createElement("a");a.setAttribute("href","#"),a.className="btn btn-blue",a.textContent="Execute",t.appendChild(a),a.addEventListener("click",async e=>{e.preventDefault(),a.remove();const o=document.createElement("div");o.className="await-approval",o.textContent="Awaiting for allowance approval";const n=document.createElement("div");n.className="await-approval-timer",n.textContent="00:00",o.appendChild(n),t.appendChild(o);const i=document.createElement("div");i.className="await-trade",i.textContent="Awaiting for transaction";const r=document.createElement("div");r.className="await-trade-timer",r.textContent="00:00",i.appendChild(r),t.appendChild(i),this.executeTradeTimer(n);const s="Warning: Transaction has failed.";await f(null,this.isBuy(),this.isCall(),this.getPaymentMethodValue(),this.getStrikeValue(),this.getAmountValue(),this.getExpiryValue())==="failure"?this.executeTradeFailure(t,s):(o.classList.add("await-active"),o.textContent="Allowance approved.",n.remove(),this.clearTradeTimer(),setTimeout(async()=>{this.executeTradeTimer(r);const m=await q(null,this.isBuy(),this.isCall(),this.getPaymentMethodValue(),this.getStrikeValue(),this.getAmountValue(),this.getExpiryValue());if(m==="")this.executeTradeFailure(t,s);else{i.classList.add("await-active"),i.textContent="Transaction mined.",r.remove(),this.clearTradeTimer();const p=document.createElement("div");p.className="approve-trade-link";const l=document.createElement("a");l.setAttribute("href",m),l.setAttribute("target","_blank"),l.className="link-arrow",l.textContent="View on Polygonscan",p.appendChild(l),t.appendChild(p)}},500))},!1)},executeTradeFailure(t,a){const e=document.createElement("div");e.className="await-failure";const o=document.createElement("div");o.className="warning-icon";const n=document.createElement("div");n.className="warning-text",n.textContent=a,e.appendChild(o),e.appendChild(n),t.appendChild(e)},executeTradeTimer(t){const a=o=>o>9?o:`0${o}`;let e=0;this.globals.execIntervalId=setInterval(()=>{e++,e>120?(this.executeTradeFailure(document.querySelector(".overlay-popup .executetrade"),"Warning: Transaction has taking longer than normal to be mined. You can close the window and try to trade again."),this.clearTradeTimer()):t.textContent=`${a(parseInt(e/60))}:${a(e%60)}`},1e3)},clearTradeTimer(){clearInterval(this.globals.execIntervalId),this.globals.execIntervalId=null,console.log("clearTradeTimer()")},transactionsTable(){k(null).then(t=>{const a=document.querySelector(".transactions .comp-dynamic-table"),e=[];t.forEach(o=>{e.push([o.Type,o.BS,o.Expiry,o.Strike,o.Amount,o.Delta,o.Gamma,o.Vega,o.Theta])}),C.setDynamic(a,e)})},isBuy(){return u.getActiveItem(document.querySelector(".opt-buysell")).toLowerCase()==="buy"},isCall(){return u.getActiveItem(document.querySelector(".opt-callput")).toLowerCase()==="call"},getPaymentMethodValue(){return u.getActiveItem(document.querySelector(".opt-token"),!0)},getStrikeValue(){return document.querySelector(".opt-strike .ds-value1").textContent.trim()},getAmountValue(){return document.querySelector("input[name='opt-amount']").value},getExpiryValue(){return document.querySelector(".opt-expiry .ds-value1").textContent.replace("Days","").replace("Day","").trim()}};export{M as default};
